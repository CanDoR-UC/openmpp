---
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# oncosimx

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![R-CMD-check](https://github.com/oncology-outcomes/oncosimx/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/oncology-outcomes/oncosimx/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

The goal of `oncosimx` is to provide a programmatic interface to the OncoSimX web-based platform directly from R to simplify creating scenarios, running models, and gathering results for further processing.

## Installation

You can install the development version of `oncosimx` from [GitHub](https://github.com/) with:

``` r
# install.packages("remotes")
remotes::install_github("oncology-outcomes/oncosimx")
```

## Usage

The `oncosimx` package contains many functions that provide access to nearly every OpenM++ API endpoint. However, users will typically only use a smaller set of functions for most tasks.

### Main Functions

- Functions for accessing tables of models, worksets, or model runs
    
    + `get_models()`
    
    + `get_worksets()` / `get_scenarios()`
    
    + `get_model_runs()` / `get_runs()`

- Functions for creating new worksets or scenarios

    + `create_scenario()` / `create_workset()`
    
- Functions for loading models, worksets, or model runs

    + `load_model()`
    
    + `load_workset()` / `load_scenario()`
    
    + `load_model_run()` / `load_run()`

- Functions for deleting worksets or model runs

    + `delete_workset()` / `delete_scenario()`
    
    + `delete_model_run()` / `delete_run()`

### Models, Scenarios, Runs, and RunSets

There are 4 main classes you will work with when using the `oncosimx` package: `OncoSimXModel`, `OncoSimXWorkset`, `OncoSimXModelRun`, and `OncoSimXModelRunSet`. Each of these are `R6` classes. `R6` is an encapsulated object-oriented programming system for R. Use the `load_*()` set of functions to load a model, workset/scenario, model run, or set of model runs into memory.

Instances of each of these 4 classes have methods and fields associated with them. You can access methods and fields using the `$` subset operator (e.g., `obj$action()` or `obj$field`)

### Example

Here we will work through a very simple example of creating a new scenario, extracting parameters to change, running the model, and extracting results. In this example we do not actually change any parameters, but users can edit the extracted CSV files and use `workset$upload_params()` to upload changed parameters.

```{r message=FALSE}
library(oncosimx)
library(ggplot2)
```

Let's see what models are available:

```{r}
get_models()
```

We can now see what worksets and model runs exist for a given model.

```{r}
get_worksets('OncoSimX-breast')
```

```{r}
get_runs('OncoSimX-breast')
```

Now we can load the `OncoSimX-breast` model to inspect.

```{r}
breast <- load_model('OncoSimX-breast')
breast
```

We will now load the `Default` set of input parameters for the Breast model.

```{r}
breast_default <- load_scenario('OncoSimX-breast', 'Default')
breast_default
```

Finally, we will load the base run for the Breast model.

```{r}
baserun_digest <- breast$run_list$RunDigest[[1]]
breast_baserun <- load_run('OncoSimX-breast', baserun_digest)
breast_baserun
```

We will create a new scenario based on the parameters from the `Default_first_run_32M_cases_12_subs` model run.

```{r eval=FALSE}
create_scenario('OncoSimX-breast', 'MyNewScenario', baserun_digest)
```

We will load the new scenario, copy over the `ProvincesOfInterest` parameter from the base run and extract it to a CSV file for editing.

```{r echo=FALSE}
new_scenario <- load_scenario('OncoSimX-breast', 'MyNewScenario')
```

```{r eval=FALSE}
new_scenario <- load_scenario('OncoSimX-breast', 'MyNewScenario')
new_scenario$copy_param('ProvincesOfInterest')
new_scenario$extract_param('ProvincesOfInterest')
```

We didn't make any changes to the parameters, but we will run the model anyway. We will give it the name `'ExampleRun'`. We use the `wait = TRUE` flag to make sure we want for the model run to finish before returning to our R session. Note that model runs may take a long time.

```{r eval=FALSE}
new_scenario$run('ExampleRun', wait = TRUE)
```

Now that our model run is complete, lets load it into memory.

```{r}
example_run <- load_run('OncoSimX-breast', 'ExampleRun')
example_run
```

We can now extract an output table from this model run using `$get_table()`.

```{r}
example_run$get_table('Breast_Cancer_Cases_Table')
```

Great, we have created a new scenario, extracted some parameters to potentially modify, ran the model, and extracted output tables. In this last step, we will load multiple model runs into memory to compare them.

```{r}
breast_runs <- load_runs('OncoSimX-breast', breast$run_list$RunDigest)
breast_runs
```

We will extract a new table from both models. Note that an extra column, `RunName` is added to indicate which model run the output table data corresponds to.

```{r}
cost_bystage <- breast_runs$get_table('Breast_Cancer_Cost_ByStage_Table')
cost_bystage
```

We can even plot this using `ggplot2`!

```{r}
cost_bystage |> 
  ggplot(aes(Stage, expr_value, fill = RunName)) +
  geom_col(position = position_dodge()) +
  labs(x = NULL, y = 'Breast Cancer Costs ($)') +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = 'bottom')
```

When we are sure we no longer need a scenario or model run, we can use `delete_scenario()` or `delete_run()` to clean things up!

## Code of Conduct

Please note that the `oncosimx` project is released with a [Contributor Code of Conduct](https://contributor-covenant.org/version/2/1/CODE_OF_CONDUCT.html). By contributing to this project, you agree to abide by its terms.
